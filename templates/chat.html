<!DOCTYPE html>
<html>
  <head>
    <title>Maqam Oud ChatBot</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
      integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU"
      crossorigin="anonymous"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://code.responsivevoice.org/responsivevoice.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='/css/ChatStyle.css') }}"
    />
  </head>
  <body>
    <script>
      // Function to greet user with voice based on time of day
      function greetUserWithVoice() {
        var hasGreeted = sessionStorage.getItem("hasGreeted");
        if (hasGreeted !== "true") {
          var today = new Date();
          var hour = today.getHours();
          var username = sessionStorage.getItem("username");
          var greeting;

          if (username) {
            if (hour < 12) {
              greeting = "Good morning, " + username + "!";
            } else if (hour < 18) {
              greeting = "Good afternoon, " + username + "!";
            } else {
              greeting = "Good evening, " + username + "!";
            }

            greeting +=
              " I'm trained to help with answering questions about Oud Instrument. Please ask me questions about the Oud instrument";

            // Add the greeting to the chat area with margin-top style for the first greeting
            appendBotMessage(greeting, true);

            // Create a SpeechSynthesisUtterance object with the greeting text
            var utterance = new SpeechSynthesisUtterance(greeting);

            // Speak the greeting
            window.speechSynthesis.speak(utterance);

            // Set the flag to true to indicate that greeting has been displayed
            sessionStorage.setItem("hasGreeted", "true");
          }
        }
      }

      function SpeakResponse(ResponseText) {
        // Add the response to the chat area
        appendBotMessage(ResponseText);

        // Create a SpeechSynthesisUtterance object with the response text
        var utterance = new SpeechSynthesisUtterance(ResponseText);

        // Speak the response
        window.speechSynthesis.speak(utterance);
      }

      // Function to append a bot message to the chat area
      function appendBotMessage(message, isFirstGreeting = false) {
        var date = new Date();
        var hour = date.getHours();
        var minute = date.getMinutes();
        var str_time = hour + ":" + (minute < 10 ? "0" + minute : minute); // Add leading zero if minute is less than 10

        var botHtml =
          '<div class="d-flex justify-content-start mb-4"' +
          (isFirstGreeting ? ' style="margin-top: 40px;"' : "") +
          '><div class="img_cont_msg"><img src="./static/images/chat/Oud-Avatar.png" class="rounded-circle user_img_msg"></div><div class="msg_cotainer">' +
          message +
          '<span class="msg_time">' +
          str_time +
          "</span></div></div>";

        $("#messageFormeight").append(botHtml);

        // Scroll to the bottom of the chat area
        var div = document.getElementById("messageFormeight");
        div.scrollTop = div.scrollHeight;

        // Save chat history to sessionStorage
        var chatHistory = $("#messageFormeight").html();
        sessionStorage.setItem("chatHistory", chatHistory);
      }

      // Function to restore chat history
      function restoreChatHistory() {
        var chatHistory = sessionStorage.getItem("chatHistory");
        if (chatHistory) {
          $("#messageFormeight").html(chatHistory);
          var div = document.getElementById("messageFormeight");
          div.scrollTop = div.scrollHeight;
        }
      }

      // Call the function when the chat.html page is loaded
      $(document).ready(function () {
        greetUserWithVoice();
        restoreChatHistory();
      });

      // Event listener for form submission
      $(document).on("submit", "#messageArea", function (event) {
        event.preventDefault();
        var rawText = $("#text").val();
        var savedUsername = sessionStorage.getItem("username");
        var savedAvatar = sessionStorage.getItem("avatar");

        var date = new Date();
        var hour = date.getHours();
        var minute = date.getMinutes();
        var str_time = hour + ":" + (minute < 10 ? "0" + minute : minute); // Add leading zero if minute is less than 10

        var userHtml =
          '<div class="d-flex justify-content-end mb-4">' +
          '<div class="msg_cotainer_send">' +
          rawText +
          "</div>" +
          '<div class="img_cont_msg"><img src="' +
          savedAvatar +
          '" class="rounded-circle user_img_msg">' +
          '<span class="username_label">' +
          savedUsername +
          "</span>" +
          // '<span class="msg_time_send">' +
          // str_time +
          // "</span>" +
          "</div></div>";

        $("#text").val("");
        $("#messageFormeight").append(userHtml);

        // Save chat history to sessionStorage
        var chatHistory = $("#messageFormeight").html();
        sessionStorage.setItem("chatHistory", chatHistory);

        // Scroll to the bottom of the chat area
        var div = document.getElementById("messageFormeight");
        div.scrollTop = div.scrollHeight;

        // Send message to the server
        $.ajax({
          data: { msg: rawText },
          type: "POST",
          url: "/chat",
          success: function (response) {
            SpeakResponse(response);
          },
        });
      });
    </script>

    <div class="card">
      <div class="card-header msg_head">
        <div class="d-flex bd-highlight">
          <div class="img_cont">
            <img
              src="./static/images/chat/Avatar_1_2.jpg"
              class="rounded-circle user_img"
            />
            <span class="online_icon"></span>
          </div>
          <div class="user_info">
            <span>Maqam Oud</span>
          </div>
        </div>
      </div>
      <div id="messageFormeight" class="card-body msg_card_body"></div>
      <div class="card-footer">
        <form
          id="messageArea"
          class="input-group"
          action="{{ url_for('submit') }}"
        >
          <input
            type="text"
            id="text"
            name="msg"
            placeholder="Type your message..."
            autocomplete="off"
            class="form-control type_msg"
            required
          />
          <div class="input-group-append">
            <button type="submit" id="send" class="input-group-text send_btn">
              <i class="fas fa-location-arrow"></i>
            </button>
          </div>
        </form>
      </div>
    </div>
  </body>
</html>
